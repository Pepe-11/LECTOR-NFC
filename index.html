<!DOCTYPE html>
<html lang="es">
<head>
  <meta charset="UTF-8">
  <meta name="viewport" content="width=device-width, initial-scale=1.0">
  <title>CheckTask - VerificaciÃ³n NFC</title>
  <style>
    * { box-sizing: border-box; margin: 0; padding: 0; }

    body {
      font-family: -apple-system, BlinkMacSystemFont, 'Segoe UI', sans-serif;
      background: #0f172a;
      color: #e2e8f0;
      min-height: 100vh;
      display: flex;
      align-items: center;
      justify-content: center;
    }

    .container {
      width: 100%;
      max-width: 420px;
      padding: 24px;
    }

    .card {
      background: #1e293b;
      border-radius: 16px;
      padding: 32px;
      border: 1px solid #334155;
      box-shadow: 0 25px 50px rgba(0,0,0,0.5);
    }

    .logo {
      text-align: center;
      margin-bottom: 28px;
    }

    .logo-icon {
      width: 56px;
      height: 56px;
      background: linear-gradient(135deg, #3b82f6, #8b5cf6);
      border-radius: 14px;
      display: inline-flex;
      align-items: center;
      justify-content: center;
      font-size: 28px;
      margin-bottom: 12px;
    }

    .logo h1 {
      font-size: 22px;
      font-weight: 700;
      color: #f1f5f9;
    }

    .logo p {
      font-size: 13px;
      color: #64748b;
      margin-top: 4px;
    }

    /* Estado de verificaciÃ³n */
    .status-box {
      border-radius: 12px;
      padding: 16px;
      margin-bottom: 20px;
      display: flex;
      align-items: center;
      gap: 12px;
      font-size: 14px;
    }

    .status-box.checking  { background: #1e3a5f; border: 1px solid #3b82f6; color: #93c5fd; }
    .status-box.success   { background: #14532d; border: 1px solid #22c55e; color: #86efac; }
    .status-box.error     { background: #450a0a; border: 1px solid #ef4444; color: #fca5a5; }
    .status-box.warning   { background: #451a03; border: 1px solid #f59e0b; color: #fcd34d; }

    .status-icon { font-size: 20px; flex-shrink: 0; }

    /* Formulario login */
    .form-group {
      margin-bottom: 16px;
    }

    label {
      display: block;
      font-size: 13px;
      font-weight: 500;
      color: #94a3b8;
      margin-bottom: 6px;
    }

    input {
      width: 100%;
      padding: 11px 14px;
      background: #0f172a;
      border: 1px solid #334155;
      border-radius: 8px;
      color: #f1f5f9;
      font-size: 15px;
      transition: border-color 0.2s;
    }

    input:focus {
      outline: none;
      border-color: #3b82f6;
      box-shadow: 0 0 0 3px rgba(59,130,246,0.15);
    }

    input::placeholder { color: #475569; }

    .btn {
      width: 100%;
      padding: 12px;
      border-radius: 8px;
      border: none;
      font-size: 15px;
      font-weight: 600;
      cursor: pointer;
      transition: all 0.2s;
    }

    .btn-primary {
      background: linear-gradient(135deg, #3b82f6, #8b5cf6);
      color: white;
    }

    .btn-primary:hover { opacity: 0.9; transform: translateY(-1px); }
    .btn-primary:disabled { opacity: 0.5; cursor: not-allowed; transform: none; }

    /* Info de tarea */
    .task-info {
      background: #0f172a;
      border-radius: 10px;
      padding: 14px;
      margin-bottom: 20px;
      border: 1px solid #1e3a5f;
    }

    .task-info-row {
      display: flex;
      justify-content: space-between;
      align-items: center;
      font-size: 13px;
      padding: 4px 0;
    }

    .task-info-label { color: #64748b; }
    .task-info-value { color: #93c5fd; font-weight: 500; font-family: monospace; }

    /* Spinner */
    .spinner {
      width: 18px;
      height: 18px;
      border: 2px solid #334155;
      border-top-color: #3b82f6;
      border-radius: 50%;
      animation: spin 0.8s linear infinite;
      flex-shrink: 0;
    }

    @keyframes spin { to { transform: rotate(360deg); } }

    .hidden { display: none; }

    .divider {
      border: none;
      border-top: 1px solid #1e293b;
      margin: 20px 0;
    }

    .session-info {
      font-size: 12px;
      color: #475569;
      text-align: center;
      margin-top: 16px;
    }

    .countdown {
      font-size: 12px;
      color: #f59e0b;
      text-align: center;
      margin-top: 8px;
    }
  </style>
</head>
<body>

<div class="container">
  <div class="card">

    <div class="logo">
      <div class="logo-icon">ğŸ“‹</div>
      <h1>CheckTask</h1>
      <p>VerificaciÃ³n de presencia NFC</p>
    </div>

    <!-- Estado del proceso -->
    <div id="status-box" class="status-box checking">
      <div class="spinner"></div>
      <span id="status-text">Verificando token NFC...</span>
    </div>

    <!-- Info de la tarea (se muestra cuando el token es vÃ¡lido) -->
    <div id="task-info" class="task-info hidden">
      <div class="task-info-row">
        <span class="task-info-label">Tarea</span>
        <span class="task-info-value" id="info-task">â€”</span>
      </div>
      <div class="task-info-row">
        <span class="task-info-label">UID tarjeta</span>
        <span class="task-info-value" id="info-uid">â€”</span>
      </div>
      <div class="task-info-row">
        <span class="task-info-label">Lectura nÂº</span>
        <span class="task-info-value" id="info-cnt">â€”</span>
      </div>
    </div>

    <!-- Formulario de login -->
    <div id="login-form" class="hidden">
      <hr class="divider">
      <div class="form-group">
        <label for="username">Usuario</label>
        <input type="text" id="username" placeholder="tu@email.com" autocomplete="username">
      </div>
      <div class="form-group">
        <label for="password">ContraseÃ±a</label>
        <input type="password" id="password" placeholder="â€¢â€¢â€¢â€¢â€¢â€¢â€¢â€¢" autocomplete="current-password">
      </div>
      <button class="btn btn-primary" id="login-btn" onclick="doLogin()">Iniciar sesiÃ³n</button>
    </div>

    <!-- BotÃ³n check (se muestra cuando ya estÃ¡ logueado) -->
    <div id="check-form" class="hidden">
      <hr class="divider">
      <button class="btn btn-primary" id="check-btn" onclick="checkTask()">
        âœ… Chequear tarea
      </button>
      <div class="countdown" id="countdown"></div>
    </div>

    <div class="session-info" id="session-info"></div>

  </div>
</div>

<script>
// â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€
// CONFIGURACIÃ“N - Ajusta estos valores
// â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€

const CONFIG = {
  // URL de tu Google Apps Script (ver instrucciones abajo)
  APPS_SCRIPT_URL: "https://script.google.com/macros/s/AKfycby4Xkkw7ZYZAIyEkY8qUKQITiXC8to1eAOU1OWYpbvJhVuCGkMXjgYf5AFPjDHQvvjDxg/exec",

  // Clave AES en hex (debe coincidir con la del script Python)
  // âš ï¸ En producciÃ³n esto debe estar en el servidor, no en el cliente
  // Por ahora lo dejamos aquÃ­ para la demo con Google Sheets
  AES_KEY_HEX: "00000000000000000000000000000000",

  // Segundos que tiene el token NFC para ser usado desde que se escanea
  TOKEN_EXPIRY_SECONDS: 120,

  // Segundos mÃ¡ximos entre lectura NFC y check (ventana de presencia)
  PRESENCE_WINDOW_SECONDS: 300,
};

// â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€
// ESTADO DE LA APP
// â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€

const state = {
  uid: null,
  cnt: null,
  mac: null,
  task: null,
  redirectUrl: null,
  tokenValid: false,
  loggedIn: false,
  user: null,
  scanTimestamp: null,
};

// â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€
// ARRANQUE - Leer parÃ¡metros de la URL
// â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€

window.addEventListener('DOMContentLoaded', async () => {
  const params = new URLSearchParams(window.location.search);

  state.uid  = params.get('uid');
  state.cnt  = params.get('cnt');
  state.mac  = params.get('mac');
  state.task = params.get('task');
  state.scanTimestamp = Date.now();

  if (!state.uid || !state.cnt || !state.mac || !state.task) {
    showStatus('error', 'âŒ URL invÃ¡lida. Escanea la tarjeta NFC de nuevo.');
    return;
  }

  // Mostrar info de tarea
  document.getElementById('info-task').textContent = decodeURIComponent(state.task);
  document.getElementById('info-uid').textContent  = state.uid;
  document.getElementById('info-cnt').textContent  = `#${parseInt(state.cnt, 16)}`;
  document.getElementById('task-info').classList.remove('hidden');

  // Verificar token con el servidor (Google Apps Script)
  await verifyToken();
});

// â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€
// VERIFICACIÃ“N DEL TOKEN SDM
// â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€

async function verifyToken() {
  showStatus('checking', 'Verificando autenticidad del token NFC...');

  try {
    const resp = await fetch(CONFIG.APPS_SCRIPT_URL, {
      method: 'POST',
      headers: { 'Content-Type': 'application/json' },
      body: JSON.stringify({
        action: 'verify_token',
        uid:    state.uid,
        cnt:    state.cnt,
        mac:    state.mac,
        task:   state.task,
      })
    });

    const data = await resp.json();

    if (!data.valid) {
      showStatus('error', `âŒ Token invÃ¡lido: ${data.reason || 'MAC incorrecto o contador repetido'}`);
      return;
    }

    state.tokenValid = true;
    state.redirectUrl = data.redirectUrl;

    showStatus('success', 'âœ… Presencia fÃ­sica verificada. Token vÃ¡lido.');
    startCountdown();

    // Comprobar si ya hay sesiÃ³n activa
    const session = getSession();
    if (session) {
      state.loggedIn = true;
      state.user = session.user;
      document.getElementById('session-info').textContent = `SesiÃ³n activa: ${session.user}`;
      document.getElementById('check-form').classList.remove('hidden');
    } else {
      document.getElementById('login-form').classList.remove('hidden');
    }

  } catch (err) {
    console.error(err);
    showStatus('error', 'âŒ Error de conexiÃ³n. Comprueba la configuraciÃ³n del servidor.');
  }
}

// â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€
// LOGIN CON GOOGLE SHEETS
// â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€

async function doLogin() {
  const username = document.getElementById('username').value.trim();
  const password = document.getElementById('password').value;

  if (!username || !password) {
    showStatus('warning', 'âš ï¸ Introduce usuario y contraseÃ±a.');
    return;
  }

  const btn = document.getElementById('login-btn');
  btn.disabled = true;
  btn.textContent = 'Verificando...';
  showStatus('checking', 'Comprobando credenciales...');

  try {
    const resp = await fetch(CONFIG.APPS_SCRIPT_URL, {
      method: 'POST',
      headers: { 'Content-Type': 'application/json' },
      body: JSON.stringify({
        action: 'login',
        username,
        password,
      })
    });

    const data = await resp.json();

    if (!data.success) {
      showStatus('error', 'âŒ Usuario o contraseÃ±a incorrectos.');
      btn.disabled = false;
      btn.textContent = 'Iniciar sesiÃ³n';
      return;
    }

    state.loggedIn = true;
    state.user = data.user;
    saveSession(data.user);

    showStatus('success', `âœ… Bienvenido, ${data.user}. Token NFC vÃ¡lido.`);
    document.getElementById('login-form').classList.add('hidden');
    document.getElementById('session-info').textContent = `SesiÃ³n activa: ${data.user}`;
    document.getElementById('check-form').classList.remove('hidden');

  } catch (err) {
    showStatus('error', 'âŒ Error de conexiÃ³n.');
    btn.disabled = false;
    btn.textContent = 'Iniciar sesiÃ³n';
  }
}

// â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€
// CHEQUEAR TAREA
// â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€

async function checkTask() {
  if (!state.tokenValid || !state.loggedIn) return;

  // Verificar que no ha pasado demasiado tiempo desde el escaneo
  const elapsed = (Date.now() - state.scanTimestamp) / 1000;
  if (elapsed > CONFIG.PRESENCE_WINDOW_SECONDS) {
    showStatus('error', 'âŒ La ventana de presencia ha expirado. Escanea la tarjeta de nuevo.');
    document.getElementById('check-form').classList.add('hidden');
    return;
  }

  const btn = document.getElementById('check-btn');
  btn.disabled = true;
  btn.textContent = 'Registrando...';

  try {
    const resp = await fetch(CONFIG.APPS_SCRIPT_URL, {
      method: 'POST',
      headers: { 'Content-Type': 'application/json' },
      body: JSON.stringify({
        action:    'check_task',
        uid:       state.uid,
        cnt:       state.cnt,
        mac:       state.mac,
        task:      state.task,
        user:      state.user,
        timestamp: new Date().toISOString(),
      })
    });

    const data = await resp.json();

    if (!data.success) {
      showStatus('error', `âŒ ${data.reason || 'Error al registrar el check.'}`);
      btn.disabled = false;
      btn.textContent = 'âœ… Chequear tarea';
      return;
    }

    showStatus('success', 'âœ… Tarea chequeada correctamente. Redirigiendo...');

    // Redirigir a la URL de la tarea en el ERP
    setTimeout(() => {
      if (state.redirectUrl) {
        window.location.href = state.redirectUrl;
      }
    }, 1500);

  } catch (err) {
    showStatus('error', 'âŒ Error de conexiÃ³n.');
    btn.disabled = false;
    btn.textContent = 'âœ… Chequear tarea';
  }
}

// â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€
// SESIÃ“N LOCAL (sessionStorage = se borra al cerrar el navegador)
// â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€

function saveSession(user) {
  sessionStorage.setItem('checktask_user', user);
  sessionStorage.setItem('checktask_ts', Date.now().toString());
}

function getSession() {
  const user = sessionStorage.getItem('checktask_user');
  const ts   = parseInt(sessionStorage.getItem('checktask_ts') || '0');
  if (!user) return null;
  // SesiÃ³n vÃ¡lida por 8 horas
  if (Date.now() - ts > 8 * 3600 * 1000) {
    sessionStorage.clear();
    return null;
  }
  return { user };
}

// â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€
// UTILIDADES UI
// â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€

function showStatus(type, text) {
  const box  = document.getElementById('status-box');
  const span = document.getElementById('status-text');

  box.className = `status-box ${type}`;

  const spinner = type === 'checking'
    ? '<div class="spinner"></div>'
    : `<span class="status-icon">${type === 'success' ? 'âœ…' : type === 'error' ? 'âŒ' : 'âš ï¸'}</span>`;

  box.innerHTML = `${spinner}<span>${text}</span>`;
}

function startCountdown() {
  const el = document.getElementById('countdown');
  const updateCountdown = () => {
    const elapsed  = (Date.now() - state.scanTimestamp) / 1000;
    const remaining = Math.max(0, CONFIG.PRESENCE_WINDOW_SECONDS - elapsed);
    if (remaining <= 0) {
      el.textContent = 'âš ï¸ Ventana de presencia expirada';
      document.getElementById('check-btn').disabled = true;
    } else {
      const min = Math.floor(remaining / 60);
      const sec = Math.floor(remaining % 60);
      el.textContent = `â±ï¸ Tiempo restante: ${min}:${sec.toString().padStart(2,'0')}`;
    }
  };
  updateCountdown();
  setInterval(updateCountdown, 1000);
}
</script>

</body>
</html>
